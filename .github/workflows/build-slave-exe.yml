name: Build Breakeven_Slave EXE

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_suffix: windows
            upload_path: dist/Breakeven_Slave.exe

          - os: ubuntu-latest
            artifact_suffix: linux
            upload_path: dist/Breakeven_Slave-x86_64.AppImage

          - os: macos-latest
            artifact_suffix: macos
            upload_path: dist/Breakeven_Slave.app.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: breakeven
          python-version: "3.11"
          channels: conda-forge
          channel-priority: strict
          auto-update-conda: true

      - name: Install core dependencies (conda)
        shell: bash -l {0}
        run: |
          conda install -y             python="3.11"             numpy=1.24.4             pandas=1.5.3             pandas-ta=0.3.14b0             scipy=1.10.1             numba=0.57.1             pyarrow=12.0.1             pyqt=5.15.9             tqdm=4.66.1             setuptools=68.2.2             pip


      - name: Install pip dependencies
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller==6.3.0



      - name: Build (Windows .exe)
        if: runner.os == 'Windows'
        shell: bash -l {0}
        run: |
          python -m PyInstaller --onefile Breakeven_Slave.py             --name Breakeven_Slave             --collect-data backtesting             --hidden-import breakeven_quant             --hidden-import pandas_ta             --hidden-import ta             --hidden-import backtesting             --hidden-import bokeh             --hidden-import seaborn             --hidden-import plotly             --hidden-import numba             --hidden-import pyarrow             --hidden-import psutil

      - name: Build (macOS .app zip)
        if: runner.os == 'macOS'
        shell: bash -l {0}
        run: |
          # Build an app bundle (onedir on macOS produces dist/Breakeven_Slave.app)
          python -m PyInstaller --onedir --windowed Breakeven_Slave.py             --name Breakeven_Slave             --collect-data backtesting             --hidden-import breakeven_quant             --hidden-import pandas_ta             --hidden-import ta             --hidden-import backtesting             --hidden-import bokeh             --hidden-import seaborn             --hidden-import plotly             --hidden-import numba             --hidden-import pyarrow             --hidden-import psutil

          # Zip the .app for easy distribution
          ditto -c -k --sequesterRsrc --keepParent "dist/Breakeven_Slave.app" "dist/Breakeven_Slave.app.zip"

      - name: Build (Linux AppImage)
        if: runner.os == 'Linux'
        shell: bash -l {0}
        run: |
          python -m PyInstaller --onefile Breakeven_Slave.py             --name Breakeven_Slave             --collect-data backtesting             --hidden-import breakeven_quant             --hidden-import pandas_ta             --hidden-import ta             --hidden-import backtesting             --hidden-import bokeh             --hidden-import seaborn             --hidden-import plotly             --hidden-import numba             --hidden-import pyarrow             --hidden-import psutil

          # Create AppDir layout
          rm -rf AppDir
          mkdir -p AppDir/usr/bin
          cp dist/Breakeven_Slave AppDir/usr/bin/Breakeven_Slave

          # Desktop entry
          cat > AppDir/Breakeven_Slave.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=Breakeven Slave
          Exec=Breakeven_Slave
          Icon=Breakeven_Slave
          Categories=Utility;
          Terminal=true
          EOF

          # Minimal 1x1 PNG icon (base64) so AppImage has an icon file
          base64 -d > AppDir/Breakeven_Slave.png << 'EOF'
          iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGD4DwABBAEAHnLrWQAAAABJRU5ErkJggg==
          EOF

          # AppRun launcher
          cat > AppDir/AppRun << 'EOF'
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          exec "$HERE/usr/bin/Breakeven_Slave" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Package AppImage
          curl -L -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

          # Extract appimagetool (NO FUSE required)
          ./appimagetool --appimage-extract

          # Run the extracted binary
          ./squashfs-root/AppRun AppDir dist/Breakeven_Slave-x86_64.AppImage

          chmod +x dist/Breakeven_Slave-x86_64.AppImage




      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Breakeven_Slave-${{ matrix.artifact_suffix }}
          path: ${{ matrix.upload_path }}
